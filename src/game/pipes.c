#include "pipes.h"
#include "../bananas/vga.h"

#define PIPE_WIDTH 26
#define PIPE_HEIGHT 100

static struct Pipes PIPES[5];

static const uint8_t pipe[PIPE_HEIGHT][PIPE_WIDTH] = {
    { 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 8, 9, 10, 11, 12, 12, 12, 12, 12, 11, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 8 },
    { 8, 11, 12, 12, 12, 12, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 11, 12, 12, 12, 12, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 11, 12, 12, 12, 12, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 11, 12, 12, 12, 12, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 11, 12, 12, 12, 12, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 11, 12, 12, 12, 12, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 11, 12, 12, 12, 12, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 11, 12, 12, 12, 12, 12, 11, 10, 9, 13, 14, 14, 15, 16, 17, 18, 18, 18, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 8 },
    { 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8 },
    { 0, 8, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 20, 22, 12, 12, 12, 22, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 22, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 22, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 15, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 22, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 22, 12, 12, 12, 11, 20, 13, 14, 15, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 22, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 15, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 15, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 9, 22, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 15, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 15, 14, 13, 20, 22, 12, 12, 12, 22, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 15, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 15, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 22, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 9, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 22, 12, 12, 12, 22, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 22, 12, 12, 12, 11, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 15, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 22, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 22, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 11, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 22, 12, 12, 12, 11, 9, 13, 14, 15, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 22, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 9, 11, 12, 12, 12, 22, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 22, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 15, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 22, 12, 12, 12, 11, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 15, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 22, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 11, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 15, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 22, 12, 12, 12, 11, 9, 13, 14, 16, 21, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 11, 20, 13, 14, 15, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 21, 16, 14, 13, 20, 11, 12, 12, 12, 22, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 20, 22, 12, 12, 12, 11, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 },
    { 0, 8, 17, 16, 14, 13, 9, 11, 12, 12, 12, 22, 9, 13, 14, 16, 17, 18, 18, 19, 19, 19, 19, 19, 8, 0 }
};

void pipes_init() {
    for (int i = 0; i < ARR_LEN(PIPES); i++) {
        PIPES[i] = (struct Pipes) {
            .x = i * 70,
            .offset = rand(i*1234) % 75
        };
    }
}

void pipes_draw() {
    for (int i = 0; i < ARR_LEN(PIPES); i++) { // num pipes
        for (int j = 0; j < 2; j++) { // top and bottom
            for (int y = 0; y < PIPE_HEIGHT; y++) {
                for (int x = 0; x < PIPE_WIDTH; x++) {
                    putpixel(pipe[j ? y : 99 - y][x], PIPES[i].x + x, j ? 180 + y - PIPES[i].offset : y - PIPES[i].offset);
                }
            }
        }
    }
}

static vec2_t PSIZE = {PIPE_WIDTH, PIPE_HEIGHT};
void pipes_update(struct Bird* bird, uint64_t tick) {
    for (int i = 0; i < ARR_LEN(PIPES); i++) {
        vec2_t pt = { PIPES[i].x, -PIPES[i].offset };
        vec2_t pb = { PIPES[i].x, 180 - PIPES[i].offset };

        bird_checkCollision(bird, pt, PSIZE);
        bird_checkCollision(bird, pb, PSIZE);

        if (PIPES[i].x >= -PIPE_WIDTH) PIPES[i].x -= 2; // loop back over screen
        else {
            PIPES[i].offset = rand(tick * 1234) % 75;
            PIPES[i].x = VGA_WIDTH;
        }
    }
}
